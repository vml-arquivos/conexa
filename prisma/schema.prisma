// ========================================
// SISTEMA CONEXA v1.0
// Schema Prisma Final - Produção
// "Conectando Vidas"
// ========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// ENUMS
// ========================================

enum Role {
  MATRIZ_ADMIN      // Poder total sobre todas as unidades
  MATRIZ_NUTRI      // Nutricionista da rede (cardápios globais)
  MATRIZ_PSYCHO     // Psicóloga (acesso a prontuários sigilosos)
  UNIT_DIRECTOR     // Diretor da unidade (gestão local)
  UNIT_SECRETARY    // Secretária (operacional)
  TEACHER           // Professor (acesso restrito à sua turma)
}

enum InventoryCategory {
  ALIMENTO          // Alimentos em geral
  HIGIENE           // Produtos de higiene (fraldas, sabonete)
  LIMPEZA           // Produtos de limpeza
  PEDAGOGICO        // Materiais pedagógicos
  MEDICAMENTO       // Medicamentos básicos
}

enum StockAlertLevel {
  OK                // Estoque normal
  LOW               // Baixo (< 7 dias)
  CRITICAL          // Crítico (< 3 dias)
  EMERGENCY         // Emergência (< 1 dia)
}

enum FoodAcceptance {
  NONE              // Recusou
  PARTIAL           // Comeu parcialmente
  FULL              // Comeu tudo
}

enum SleepQuality {
  BOM               // Dormiu bem
  AGITADO           // Sono agitado
  NAO_DORMIU        // Não dormiu
}

enum Mood {
  FELIZ             // Feliz
  TRISTE            // Triste
  AGITADO           // Agitado
  CALMO             // Calmo
}

// ========================================
// 1. HIERARQUIA (RBAC)
// ========================================

model Association {
  id          String   @id @default(uuid())
  name        String   // "Associação Beneficente Coração de Cristo"
  cnpj        String   @unique
  address     String
  phone       String
  email       String
  
  // Relacionamentos
  schools     School[]
  menus       Menu[]   // Cardápios globais
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("associations")
}

model School {
  id              String   @id @default(uuid())
  name            String   // "CEPI Arara Canindé"
  code            String   @unique // "CEPI-001"
  address         String
  phone           String
  email           String
  
  // Relacionamento com Matriz
  associationId   String
  association     Association @relation(fields: [associationId], references: [id], onDelete: Cascade)
  
  // Relacionamentos
  users           User[]
  classes         Class[]
  students        Student[]
  inventoryItems  InventoryItem[]
  menus           Menu[]
  consumptionLogs ConsumptionLog[]
  
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("schools")
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String
  name          String
  cpf           String?  @unique
  phone         String?
  role          Role
  
  // Multi-tenancy: Usuários de UNIDADE/TEACHER têm schoolId
  schoolId      String?
  school        School?  @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // TEACHER: Acesso restrito à turma
  classId       String?
  class         Class?   @relation(fields: [classId], references: [id], onDelete: SetNull)
  
  // Relacionamentos
  psychologicalRecords PsychologicalRecord[]
  
  // Auditoria
  lastLogin     DateTime?
  isActive      Boolean  @default(true)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@map("users")
}

// ========================================
// 2. MÓDULO "ZELO" (ESTOQUE & NUTRIÇÃO)
// ========================================

model InventoryItem {
  id                    String              @id @default(uuid())
  name                  String              // "Fralda P"
  category              InventoryCategory
  quantity              Float               // Quantidade atual
  unit                  String              // "unidade", "kg", "litro"
  minThreshold          Float               // Alerta quando < minThreshold
  
  // Previsão de estoque
  avgDailyConsumption   Float?              // Consumo médio diário
  daysRemaining         Int?                // Dias restantes
  alertLevel            StockAlertLevel     @default(OK)
  lastAlertSent         DateTime?
  
  // Multi-tenancy
  schoolId              String
  school                School              @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Relacionamentos
  consumptionLogs       ConsumptionLog[]
  
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  
  @@map("inventory_items")
}

model ConsumptionLog {
  id          String        @id @default(uuid())
  quantity    Float         // Quantidade consumida
  reason      String?       // Motivo (opcional)
  
  // Relacionamentos
  itemId      String
  item        InventoryItem @relation(fields: [itemId], references: [id], onDelete: Cascade)
  
  schoolId    String
  school      School        @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  classId     String?
  class       Class?        @relation(fields: [classId], references: [id], onDelete: SetNull)
  
  createdAt   DateTime      @default(now())
  
  @@map("consumption_logs")
}

model Menu {
  id              String       @id @default(uuid())
  name            String       // "Cardápio Semana 1"
  weekNumber      Int          // Número da semana
  year            Int
  
  // JSON com estrutura:
  // {
  //   "monday": { "breakfast": "...", "lunch": "...", "snack": "..." },
  //   "tuesday": { ... }
  // }
  meals           Json
  
  // Cardápio global (MATRIZ) ou local (SCHOOL)
  associationId   String?
  association     Association? @relation(fields: [associationId], references: [id], onDelete: Cascade)
  
  schoolId        String?
  school          School?      @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  isActive        Boolean      @default(true)
  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
  
  @@map("menus")
}

// ========================================
// 3. MÓDULO "SUPER PEDAGOGO" & IA
// ========================================

model Class {
  id              String   @id @default(uuid())
  name            String   // "Berçário 1"
  level           String   // "0-1 anos", "2-3 anos", "4 anos"
  capacity        Int      // Capacidade máxima
  
  // Multi-tenancy
  schoolId        String
  school          School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Relacionamentos
  students        Student[]
  users           User[]   // Professores
  dailyLogs       DailyLog[]
  bnccPlannings   BNCCPlanning[]
  consumptionLogs ConsumptionLog[]
  
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("classes")
}

model Student {
  id                      String                  @id @default(uuid())
  name                    String
  birthDate               DateTime
  cpf                     String?                 @unique
  
  // Dados de saúde (JSON)
  // { "allergies": ["lactose", "gluten"], "medications": ["..."] }
  healthData              Json?
  
  // Responsáveis (JSON)
  // [{ "name": "...", "phone": "...", "relationship": "mãe" }]
  guardians               Json
  
  // Multi-tenancy
  schoolId                String
  school                  School                  @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  classId                 String
  class                   Class                   @relation(fields: [classId], references: [id], onDelete: Cascade)
  
  // Relacionamentos
  dailyLogs               DailyLog[]
  psychologicalRecords    PsychologicalRecord[]
  
  status                  String                  @default("ACTIVE") // ACTIVE, INACTIVE, TRANSFERRED
  createdAt               DateTime                @default(now())
  updatedAt               DateTime                @updatedAt
  
  @@map("students")
}

model DailyLog {
  id              String          @id @default(uuid())
  date            DateTime        @default(now())
  
  // Alimentação
  breakfast       FoodAcceptance?
  morningSnack    FoodAcceptance?
  lunch           FoodAcceptance?
  afternoonSnack  FoodAcceptance?
  
  // Sono
  slept           Boolean?
  sleepDuration   Int?            // Minutos
  sleepQuality    SleepQuality?
  
  // Higiene
  diaperChanges   Int?            // Número de trocas
  bathed          Boolean?
  teethBrushed    Boolean?
  
  // Evacuação
  evacuation      String?         // "NORMAL", "DIARREIA", "CONSTIPACAO", "NAO_HOUVE"
  
  // Humor e Comportamento
  mood            Mood?
  behavior        String?         // Texto livre
  
  // Observações
  observations    String?
  
  // Alertas gerados pela IA (JSON)
  alerts          Json?
  
  // Relacionamentos
  studentId       String
  student         Student         @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  classId         String
  class           Class           @relation(fields: [classId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  
  @@map("daily_logs")
}

model PsychologicalRecord {
  id              String   @id @default(uuid())
  date            DateTime @default(now())
  observation     String   @db.Text
  isConfidential  Boolean  @default(true)
  
  // Relacionamentos
  studentId       String
  student         Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  psychologistId  String
  psychologist    User     @relation(fields: [psychologistId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  @@map("psychological_records")
}

model BNCCPlanning {
  id          String   @id @default(uuid())
  date        DateTime
  title       String
  description String   @db.Text
  
  // Códigos BNCC (Array de strings)
  // Ex: ["CE01", "CE02"]
  bnccCodes   String[]
  
  // Materiais necessários (JSON)
  // [{ "name": "Papel A4", "quantity": 20 }]
  materials   Json?
  
  // Duração (minutos)
  duration    Int?
  
  // Gerado por IA
  aiGenerated Boolean  @default(false)
  aiContext   String?  @db.Text
  
  // Relacionamentos
  classId     String
  class       Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@map("bncc_plannings")
}

