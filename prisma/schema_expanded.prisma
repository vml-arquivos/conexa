// CoCris Super System - Schema Expandido
// Versão: 2.0
// Data: 31/01/2026

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========== GESTÃO ESCOLAR ==========

model School {
  id        String    @id @default(uuid())
  name      String
  planType  String    @default("ENTERPRISE")
  address   String?
  phone     String?
  email     String?
  
  students     Student[]
  employees    Employee[]
  inventory    InventoryItem[]
  classes      Class[]
  suppliers    Supplier[]
  materialLists MaterialList[]
  cardapios    Cardapio[]
  planejamentosTemplate PlanejamentoTemplate[]
  atividadesTemplate    AtividadeTemplate[]
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

// ========== TURMAS ==========
model Class {
  id          String   @id @default(uuid())
  name        String   // "Berçário 1", "Maternal 2", "Pré 1"
  level       String   // "BERCARIO", "MATERNAL_1", "MATERNAL_2", "PRE_1", "PRE_2"
  faixaEtaria String   // "0-1", "1-2", "2-3", "3-4"
  year        Int      // 2025, 2026
  capacidade  Int?     // Número máximo de alunos
  
  students    Student[]
  materialList MaterialList?
  diariosBordo DiarioDeBordo[]
  planejamentosDiarios PlanejamentoDiario[]
  
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ========== ALUNOS ==========
model Student {
  id          String   @id @default(uuid())
  name        String
  birthDate   DateTime?
  email       String?
  phone       String?
  status      String   @default("ACTIVE") // ACTIVE, INACTIVE, EVADED, ARCHIVED
  
  // Responsável
  responsavelName String?
  responsavelEmail String?
  responsavelPhone String?
  
  // DADOS FLEXÍVEIS
  healthData  Json?    // { alergias, medicamentos, tea, etc }
  academicData Json?   // { notas, historico, etc }
  attendance   Json?   // { faltasConsecutivas, total, etc }
  
  documents   Document[]
  restricoesAlimentares RestricaoAlimentar[]
  registrosAlimentacao  RegistroAlimentacao[]
  registrosSono         RegistroSono[]
  registrosHigiene      RegistroHigiene[]
  diariosBordo          DiarioDeBordo[]
  
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  classId     String?
  class       Class?   @relation(fields: [classId], references: [id], onDelete: SetNull)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ========== FUNCIONÁRIOS ==========
model Employee {
  id          String   @id @default(uuid())
  name        String
  category    String   // "DIRETOR", "COORDENADOR", "PROFESSOR", "LIMPEZA", "COZINHA", "NUTRICIONISTA"
  email       String?
  phone       String?
  cpf         String?  @unique
  status      String   @default("ACTIVE") // ACTIVE, INACTIVE, ARCHIVED
  
  // Informações profissionais
  hireDate    DateTime?
  salary      Decimal?
  department  String?  // "ADMINISTRATIVO", "PEDAGOGICO", "OPERACIONAL"
  
  // DADOS FLEXÍVEIS
  personalData Json?   // { endereco, cidade, estado, etc }
  
  documents   Document[]
  planejamentosTemplate PlanejamentoTemplate[]
  atividadesTemplate    AtividadeTemplate[]
  planejamentosDiarios  PlanejamentoDiario[]
  registrosAlimentacao  RegistroAlimentacao[]
  registrosSono         RegistroSono[]
  registrosHigiene      RegistroHigiene[]
  diariosBordo          DiarioDeBordo[]
  
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ========== DOCUMENTOS ==========
model Document {
  id          String   @id @default(uuid())
  type        String   // RG, CONTRATO, FOTO, VACINA, DIPLOMA, CERTIFICADO, ATESTADO
  url         String   // Caminho do arquivo
  filename    String
  fileSize    Int?     // Tamanho em bytes
  mimeType    String?  // application/pdf, image/jpeg
  expiryDate  DateTime? // Data de vencimento (se aplicável)
  
  studentId   String?
  student     Student? @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  employeeId  String?
  employee    Employee? @relation(fields: [employeeId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ========== ESTOQUE ==========
model InventoryItem {
  id           String   @id @default(uuid())
  name         String
  category     String   // HIGIENE, PEDAGOGICO, ALIMENTACAO
  quantity     Int      @default(0)
  minThreshold Int      @default(10)
  unit         String   @default("un")
  
  // Campos de Compras
  sku          String?
  lastPrice    Decimal? @default(0.0)
  supplier     String?
  lastUpdated  DateTime @default(now())
  
  schoolId     String
  school       School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
}

// ========== LISTAS DE MATERIAIS POR TURMA ==========
model MaterialList {
  id          String   @id @default(uuid())
  classId     String   @unique
  class       Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  items       MaterialListItem[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model MaterialListItem {
  id            String   @id @default(uuid())
  name          String
  category      String   // HIGIENE, PEDAGOGICO, ALIMENTACAO
  quantity      Int
  unit          String   @default("un")
  description   String?
  
  listId        String
  list          MaterialList @relation(fields: [listId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())
}

// ========== FORNECEDORES ==========
model Supplier {
  id          String   @id @default(uuid())
  name        String
  email       String?
  phone       String?
  website     String?
  
  // Endereço
  address     String?
  city        String?
  state       String?
  zipCode     String?
  
  // Contato
  contactPerson String?
  contactEmail  String?
  contactPhone  String?
  
  products    SupplierProduct[]
  priceList   SupplierPriceList[]
  
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ========== PRODUTOS DO FORNECEDOR ==========
model SupplierProduct {
  id          String   @id @default(uuid())
  sku         String
  name        String
  category    String   // HIGIENE, PEDAGOGICO, ALIMENTACAO
  price       Decimal
  unit        String   @default("un")
  description String?
  
  supplierId  String
  supplier    Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([supplierId, sku])
}

// ========== TABELA DE PREÇOS DO FORNECEDOR ==========
model SupplierPriceList {
  id          String   @id @default(uuid())
  name        String   // "Tabela 2025", "Promoção Jan"
  xmlUrl      String?  // URL do arquivo XML
  xmlData     Json?    // Dados parseados do XML
  
  supplierId  String
  supplier    Supplier @relation(fields: [supplierId], references: [id], onDelete: Cascade)
  
  validFrom   DateTime
  validUntil  DateTime?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ========== PEDIDOS DE COMPRA ==========
model ProcurementOrder {
  id          String   @id @default(uuid())
  orderNumber String   @unique
  status      String   @default("DRAFT") // DRAFT, PENDING, APPROVED, COMPLETED, CANCELLED
  
  // Origem
  classId     String?  // Se for por turma
  schoolId    String
  
  // Fornecedor
  supplierId  String?
  supplierName String?
  
  items       ProcurementItem[]
  totalValue  Decimal  @default(0.0)
  
  // Observações
  notes       String?
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model ProcurementItem {
  id          String   @id @default(uuid())
  sku         String?
  itemName    String
  category    String?
  quantity    Int
  unitPrice   Decimal
  subtotal    Decimal
  unit        String   @default("un")
  
  orderId     String
  order       ProcurementOrder @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
}

// ========== MÓDULO PEDAGÓGICO (BNCC) ==========

model CampoExperienciaBNCC {
  id          String   @id @default(uuid())
  codigo      String   @unique // "CE01", "CE02", "CE03", "CE04", "CE05"
  nome        String   // "O eu, o outro e o nós", etc.
  descricao   String   @db.Text
  faixaEtaria String   // "0-1", "1-3", "3-4", "0-4"
  objetivos   Json     // Array de objetivos de aprendizagem
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model PlanejamentoTemplate {
  id                    String   @id @default(uuid())
  titulo                String
  nivelEnsino           String   // "BERCARIO", "MATERNAL_1", "MATERNAL_2", "PRE_1", "PRE_2"
  faixaEtaria           String   // "0-1", "1-2", "2-3", "3-4"
  camposExperiencia     Json     // Array de códigos dos campos de experiência
  habilidadesBNCC       Json     // Array de códigos BNCC (se aplicável)
  objetivosAprendizagem String   @db.Text
  atividadeDirigida     String?  @db.Text
  desenvolvimento       String   @db.Text
  atividadesImpressao   String?  @db.Text
  avaliacao             String   @db.Text
  tema                  String?
  duracao               Int      // Duração em minutos
  publico               Boolean  @default(true)
  editavel              Boolean  @default(true)
  
  schoolId              String
  school                School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  autorId               String?
  autor                 Employee? @relation(fields: [autorId], references: [id], onDelete: SetNull)
  
  planejamentosDiarios  PlanejamentoDiario[]
  
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
}

model AtividadeTemplate {
  id                String   @id @default(uuid())
  titulo            String
  descricao         String   @db.Text
  tipo              String   // "EXERCICIO", "PROJETO", "QUIZ", "DISCUSSAO", "CRIATIVO"
  nivelEnsino       String
  faixaEtaria       String
  habilidadesBNCC   Json
  camposExperiencia Json?
  dificuldade       String   // "FACIL", "MEDIO", "DIFICIL"
  tempoEstimado     Int      // Em minutos
  arquivo           String?  // URL do arquivo
  publico           Boolean  @default(true)
  
  schoolId          String
  school            School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  autorId           String?
  autor             Employee? @relation(fields: [autorId], references: [id], onDelete: SetNull)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
}

model PlanejamentoDiario {
  id                String   @id @default(uuid())
  data              DateTime
  templateId        String?
  template          PlanejamentoTemplate? @relation(fields: [templateId], references: [id], onDelete: SetNull)
  
  classId           String
  class             Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  
  professorId       String
  professor         Employee @relation(fields: [professorId], references: [id], onDelete: Cascade)
  
  atividadesRealizadas Json?  // Array de atividades marcadas como realizadas
  observacoes       String?  @db.Text
  realizado         Boolean  @default(false)
  
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt
  
  @@unique([classId, data])
}

// ========== MÓDULO NUTRIÇÃO ==========

model Cardapio {
  id          String   @id @default(uuid())
  nome        String   // "Cardápio Semana 1 - Janeiro 2025"
  descricao   String?  @db.Text
  dataInicio  DateTime
  dataFim     DateTime
  ativo       Boolean  @default(true)
  
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  refeicoes   Refeicao[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model Refeicao {
  id            String   @id @default(uuid())
  tipo          String   // "CAFE", "ALMOCO", "LANCHE_MANHA", "LANCHE_TARDE"
  diaSemana     Int      // 1-7 (Segunda a Domingo)
  horario       String   // "08:00"
  descricao     String   @db.Text // "Mingau de aveia com banana"
  ingredientes  Json     // Array de ingredientes
  valorNutricional Json? // { calorias, proteinas, carboidratos, etc }
  observacoes   String?  @db.Text
  
  cardapioId    String
  cardapio      Cardapio @relation(fields: [cardapioId], references: [id], onDelete: Cascade)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

model RestricaoAlimentar {
  id          String   @id @default(uuid())
  tipo        String   // "ALERGIA", "INTOLERANCIA", "RELIGIOSA", "VEGETARIANA", "VEGANA"
  alimento    String   // "Leite", "Glúten", "Carne"
  descricao   String?  @db.Text
  gravidade   String   // "LEVE", "MODERADA", "GRAVE"
  documentoMedico String? // URL do documento médico (se aplicável)
  
  studentId   String
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model RegistroAlimentacao {
  id          String   @id @default(uuid())
  data        DateTime
  refeicaoTipo String  // "CAFE", "ALMOCO", "LANCHE_MANHA", "LANCHE_TARDE"
  horario     String   // "08:30"
  aceitacao   String   // "COMEU_TUDO", "COMEU_PARCIAL", "NAO_COMEU", "RECUSOU"
  quantidade  String?  // "50%", "75%", "100%"
  observacoes String?  @db.Text
  
  studentId   String
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  professorId String
  professor   Employee @relation(fields: [professorId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

// ========== MÓDULO AGENDA DIGITAL (DIÁRIO DE BORDO) ==========

model DiarioDeBordo {
  id          String   @id @default(uuid())
  data        DateTime
  
  studentId   String
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  classId     String
  class       Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  
  professorId String
  professor   Employee @relation(fields: [professorId], references: [id], onDelete: Cascade)
  
  // Sono
  sonoHorarios Json?   // [{ inicio: "09:00", fim: "10:30", qualidade: "BOM" }]
  sonoTotal    Int?    // Minutos totais
  sonoQualidade String? // "BOM", "AGITADO", "INTERROMPIDO"
  
  // Alimentação (resumo)
  alimentacaoResumo Json? // { cafe: "COMEU_TUDO", almoco: "COMEU_PARCIAL", etc }
  
  // Higiene
  trocasFralda Int?    @default(0)
  banho        Boolean @default(false)
  banhoHorario String?
  evacuacao    String? // "NORMAL", "DIARREIA", "CONSTIPACAO", "NAO_EVACUOU"
  evacuacaoHorario String?
  
  // Humor e Comportamento
  humor        String? // "FELIZ", "CHOROSO", "IRRITADO", "TRANQUILO", "AGITADO"
  comportamento String? @db.Text
  
  // Atividades Realizadas
  atividades   Json?   // Array de atividades do dia
  
  // Observações Gerais
  observacoes  String?  @db.Text
  
  // Comunicação com Responsáveis
  comunicadoResponsavel String? @db.Text
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@unique([studentId, data])
}

model RegistroSono {
  id          String   @id @default(uuid())
  data        DateTime
  horaInicio  String   // "09:00"
  horaFim     String?  // "10:30"
  duracao     Int?     // Minutos
  qualidade   String   // "BOM", "AGITADO", "INTERROMPIDO"
  observacoes String?  @db.Text
  
  studentId   String
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  professorId String
  professor   Employee @relation(fields: [professorId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model RegistroHigiene {
  id          String   @id @default(uuid())
  data        DateTime
  tipo        String   // "TROCA_FRALDA", "BANHO", "ESCOVACAO"
  horario     String
  observacoes String?  @db.Text
  
  studentId   String
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  professorId String
  professor   Employee @relation(fields: [professorId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}
