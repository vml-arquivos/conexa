// ========================================
// SISTEMA CONEXA v1.0
// ERP Educacional para Rede CoCris
// "Conectando Vidas"
// ========================================

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ========================================
// AUTENTICAÇÃO E CONTROLE DE ACESSO (RBAC)
// ========================================

enum UserRole {
  MATRIZ_ADMIN      // Poder total sobre todas as unidades
  MATRIZ_NUTRI      // Nutricionista da rede (cardápios globais)
  MATRIZ_PSYCHO     // Psicóloga (acesso a prontuários sigilosos)
  UNIT_DIRECTOR     // Diretor da unidade (gestão local)
  UNIT_SECRETARY    // Secretária (operacional)
  TEACHER           // Professor (acesso restrito à sua turma)
}

model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String
  name          String
  role          UserRole
  
  // Multi-tenancy: Usuários de UNIDADE/TEACHER têm schoolId
  schoolId      String?
  school        School?  @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // TEACHER: Acesso restrito à turma
  classId       String?
  class         Class?   @relation(fields: [classId], references: [id], onDelete: SetNull)
  
  // Auditoria
  lastLogin     DateTime?
  isActive      Boolean  @default(true)
  
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  @@index([schoolId])
  @@index([role])
}

// ========================================
// HIERARQUIA: REDE -> UNIDADES -> TURMAS
// ========================================

model School {
  id        String    @id @default(uuid())
  name      String    // "CEPI Arara Canindé", "Creche CoCris Sede"
  code      String    @unique // "ARARA", "SEDE"
  address   String?
  phone     String?
  email     String?
  
  // Relacionamentos
  users         User[]
  classes       Class[]
  students      Student[]
  inventory     InventoryItem[]
  dailyLogs     DailyLog[]
  bnccPlannings BNCCPlanning[]
  
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Class {
  id          String   @id @default(uuid())
  name        String   // "Berçário 1", "Maternal 2"
  level       String   // "Berçário", "Maternal", "Pré"
  ageRange    String   // "0-1 ano", "2-3 anos"
  year        Int      // 2026
  
  // Multi-tenancy
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  // Relacionamentos
  users       User[]   // Professores da turma
  students    Student[]
  dailyLogs   DailyLog[]
  bnccPlannings BNCCPlanning[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([schoolId])
}

// ========================================
// CRIANÇAS (0-4 ANOS)
// ========================================

model Student {
  id          String   @id @default(uuid())
  name        String
  birthDate   DateTime
  gender      String?  // "M", "F"
  photo       String?  // URL da foto
  
  // Responsáveis
  responsavel1Name  String?
  responsavel1Phone String?
  responsavel1Email String?
  responsavel2Name  String?
  responsavel2Phone String?
  
  // Saúde (Dados Sensíveis)
  healthData  Json?    // { alergias: [], medicamentos: [], tea: false, observacoes: "" }
  
  // Multi-tenancy
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  classId     String?
  class       Class?   @relation(fields: [classId], references: [id], onDelete: SetNull)
  
  // Relacionamentos
  dailyLogs   DailyLog[]
  psychRecords PsychologicalRecord[]
  foodRestrictions FoodRestriction[]
  
  status      String   @default("ACTIVE") // ACTIVE, INACTIVE, TRANSFERRED
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([schoolId])
  @@index([classId])
}

// ========================================
// TABELAS DE DIGNIDADE (ZELO)
// ========================================

enum InventoryCategory {
  DIGNITY_CRITICAL  // Fraldas, Leite, Água (NÃO podem faltar)
  HYGIENE           // Sabonete, Papel higiênico
  FOOD              // Alimentos
  PEDAGOGICAL       // Materiais pedagógicos
  CLEANING          // Produtos de limpeza
  MEDICINE          // Medicamentos básicos
}

enum StockAlertLevel {
  OK        // Estoque normal
  LOW       // Abaixo do mínimo (< 7 dias)
  CRITICAL  // Crítico (< 3 dias)
  EMERGENCY // Emergência (< 1 dia)
}

model InventoryItem {
  id           String   @id @default(uuid())
  name         String   // "Fralda G", "Leite sem Lactose"
  category     InventoryCategory
  quantity     Int      @default(0)
  unit         String   @default("un") // "un", "kg", "L", "pct"
  
  // Previsão de Consumo (ZELO)
  avgDailyConsumption Decimal? @default(0.0) // Consumo médio diário
  daysRemaining       Int?     @default(0)    // Dias restantes
  alertLevel          StockAlertLevel @default(OK)
  lastAlertSent       DateTime?
  
  // Limites
  minThreshold Int      @default(10)  // Quantidade mínima
  maxThreshold Int?                   // Quantidade máxima (opcional)
  
  // Compras
  lastPrice    Decimal? @default(0.0)
  supplier     String?
  
  // Multi-tenancy
  schoolId     String
  school       School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  @@index([schoolId])
  @@index([category])
  @@index([alertLevel])
}

// ========================================
// TABELAS PEDAGÓGICAS (BNCC + DIÁRIO)
// ========================================

model BNCCField {
  id          String   @id @default(uuid())
  code        String   @unique // "CE01", "CE02", "CE03", "CE04", "CE05"
  name        String   // "O eu, o outro e o nós"
  description String   @db.Text
  objectives  Json     // { "0-1": ["obj1", "obj2"], "2-3": [...] }
  
  plannings   BNCCPlanning[]
  
  createdAt   DateTime @default(now())
}

model BNCCPlanning {
  id          String   @id @default(uuid())
  title       String   // "Exploração Sensorial com Texturas"
  description String   @db.Text
  ageRange    String   // "0-1 ano", "2-3 anos"
  duration    Int      // Duração em minutos
  materials   Json?    // ["Areia", "Água", "Massinha"]
  
  // BNCC
  bnccFieldId String
  bnccField   BNCCField @relation(fields: [bnccFieldId], references: [id])
  
  // Multi-tenancy
  schoolId    String?
  school      School?  @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  classId     String?
  class       Class?   @relation(fields: [classId], references: [id], onDelete: SetNull)
  
  // IA Mentora
  aiGenerated Boolean  @default(false)
  aiContext   String?  @db.Text // Contexto usado para gerar a atividade
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([schoolId])
  @@index([classId])
  @@index([bnccFieldId])
}

model DailyLog {
  id          String   @id @default(uuid())
  date        DateTime @default(now())
  
  // Criança
  studentId   String
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  // Multi-tenancy
  schoolId    String
  school      School   @relation(fields: [schoolId], references: [id], onDelete: Cascade)
  
  classId     String
  class       Class    @relation(fields: [classId], references: [id], onDelete: Cascade)
  
  // ROTINA DIÁRIA (Registro Rápido)
  
  // Alimentação (4 refeições)
  breakfast   String?  // "COMEU_TUDO", "COMEU_METADE", "RECUSOU"
  morningSnack String?
  lunch       String?
  afternoonSnack String?
  
  // Sono
  sleepStart  DateTime?
  sleepEnd    DateTime?
  sleepQuality String? // "BOM", "AGITADO", "NAO_DORMIU"
  
  // Higiene
  diaperChanges Int?   @default(0)
  bathTaken     Boolean @default(false)
  teethBrushed  Boolean @default(false)
  
  // Evacuação
  bowelMovement String? // "NORMAL", "DIARREIA", "CONSTIPACAO", "NAO_HOUVE"
  
  // Humor e Comportamento
  mood        String?  // "FELIZ", "TRISTE", "AGITADO", "CALMO"
  behavior    String?  @db.Text // Observações livres
  
  // Observações Gerais
  notes       String?  @db.Text
  
  // Alertas Automáticos (IA Mentora)
  alerts      Json?    // [{ type: "ALIMENTACAO", message: "Recusou 2 refeições" }]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([studentId])
  @@index([schoolId])
  @@index([classId])
  @@index([date])
}

// ========================================
// PRONTUÁRIOS PSICOLÓGICOS (SIGILOSO)
// Acesso: APENAS MATRIZ_PSYCHO
// ========================================

model PsychologicalRecord {
  id          String   @id @default(uuid())
  studentId   String
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  date        DateTime @default(now())
  sessionType String   // "AVALIACAO", "ACOMPANHAMENTO", "ENCAMINHAMENTO"
  
  // Conteúdo Sigiloso
  observations String  @db.Text
  diagnosis    String? @db.Text
  recommendations String? @db.Text
  
  // Quem criou (MATRIZ_PSYCHO)
  createdBy   String   // userId
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([studentId])
}

// ========================================
// NUTRIÇÃO (MATRIZ_NUTRI)
// ========================================

model FoodRestriction {
  id          String   @id @default(uuid())
  studentId   String
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  
  type        String   // "ALERGIA", "INTOLERANCIA", "RESTRICAO_RELIGIOSA"
  food        String   // "Leite", "Glúten", "Carne de Porco"
  severity    String   // "LEVE", "MODERADA", "GRAVE"
  notes       String?  @db.Text
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([studentId])
}

model Menu {
  id          String   @id @default(uuid())
  name        String   // "Cardápio Semanal - Janeiro 2026"
  weekStart   DateTime
  weekEnd     DateTime
  
  // Refeições (JSON estruturado)
  meals       Json     // { "segunda": { "breakfast": "...", "lunch": "..." }, ... }
  
  // Criado por MATRIZ_NUTRI
  createdBy   String   // userId
  
  // Aplicável a todas as unidades ou específica?
  isGlobal    Boolean  @default(true)
  schoolId    String?  // Se não for global
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([weekStart])
}

// ========================================
// ÍNDICES E OTIMIZAÇÕES
// ========================================

// Índices adicionais para performance:
// - schoolId em todas as tabelas multi-tenant
// - date em DailyLog (consultas por período)
// - alertLevel em InventoryItem (alertas críticos)
// - role em User (controle de acesso)
